<!-- Markmap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.4/dist/style.css">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.14.4"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.14.4/dist/browser/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.14.4/dist/index.min.js"></script>
<script>
  // Auto-fit markmap + lightbox zoom (matching medium-zoom interaction)
  (function () {
    // ── Auto-fit: measure content, resize wrapper, freeze viewBox ──
    function freezeMarkmap(wrapper) {
      var svg = wrapper.querySelector('svg');
      if (!svg) return false;
      var g = svg.querySelector('g');
      if (!g || !g.children.length) return false;

      var gRect = g.getBoundingClientRect();
      var svgRect = svg.getBoundingClientRect();
      if (gRect.width === 0 || gRect.height === 0) return false;
      if (svgRect.width === 0 || svgRect.height === 0) return false;

      var contentBottom = gRect.bottom - svgRect.top;
      var padding = 30;
      var newHeight = Math.round(contentBottom + padding);
      newHeight = Math.max(300, Math.min(newHeight, window.innerHeight * 0.9));

      var vb = svg.viewBox.baseVal;
      var viewBoxStr;
      if (vb && vb.width > 0 && vb.height > 0) {
        var vbNewHeight = vb.height * (newHeight / svgRect.height);
        viewBoxStr = vb.x + ' ' + vb.y + ' ' + vb.width + ' ' + vbNewHeight;
      } else {
        viewBoxStr = '0 0 ' + svgRect.width + ' ' + newHeight;
      }

      svg.setAttribute('viewBox', viewBoxStr);
      svg.setAttribute('preserveAspectRatio', 'xMidYMin meet');
      svg.style.height = newHeight + 'px';
      wrapper.style.height = newHeight + 'px';
      return true;
    }

    function adjustAllMarkmaps() {
      var adjusted = false;
      document.querySelectorAll('.markmap-wrapper').forEach(function (wrapper) {
        if (wrapper.dataset.fitted) return;
        if (!freezeMarkmap(wrapper)) return;
        wrapper.dataset.fitted = '1';
        adjusted = true;
      });
      return adjusted;
    }

    var attempts = 0;
    var maxAttempts = 20;
    var timer = setInterval(function () {
      attempts++;
      if (adjustAllMarkmaps() || attempts >= maxAttempts) {
        clearInterval(timer);
      }
    }, 500);

    // ── Lightbox zoom (matching medium-zoom interaction) ──
    var activeLightbox = null;

    function closeLightbox() {
      if (!activeLightbox) return;
      var lb = activeLightbox;
      activeLightbox = null;
      lb.classList.remove('is-active');
      setTimeout(function () {
        if (lb.parentNode) lb.parentNode.removeChild(lb);
      }, 300);
      document.body.style.overflow = '';
    }

    function openLightbox(wrapper) {
      if (activeLightbox) return;

      // Get markmap source from data-source attribute (persists after autoloader)
      var mdContent = wrapper.dataset.source;
      if (!mdContent) return;

      // Create lightbox overlay
      var overlay = document.createElement('div');
      overlay.className = 'markmap-lightbox';

      // Create content container
      var content = document.createElement('div');
      content.className = 'markmap-lightbox-content';

      // Close button
      var closeBtn = document.createElement('button');
      closeBtn.className = 'markmap-lightbox-close';
      closeBtn.title = 'Close';
      closeBtn.setAttribute('aria-label', 'Close');
      closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

      // Create SVG for markmap rendering
      var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.id = 'markmap-lightbox-svg-' + Date.now();

      content.appendChild(closeBtn);
      content.appendChild(svg);
      overlay.appendChild(content);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';
      activeLightbox = overlay;

      // Animate in
      requestAnimationFrame(function () {
        requestAnimationFrame(function () {
          overlay.classList.add('is-active');
        });
      });

      // Render markmap in lightbox using markmap-view
      try {
        var transformer = new markmap.Transformer();
        var result = transformer.transform(mdContent);
        var mm = markmap.Markmap.create(svg, null, result.root);
        // Fit after a short delay to ensure proper sizing
        setTimeout(function () { mm.fit(); }, 200);
      } catch (e) {
        // Fallback: clone the SVG from original
        var origSvg = wrapper.querySelector('svg');
        if (origSvg) {
          var cloned = origSvg.cloneNode(true);
          cloned.removeAttribute('viewBox');
          cloned.removeAttribute('preserveAspectRatio');
          cloned.style.width = '100%';
          cloned.style.height = '100%';
          content.replaceChild(cloned, svg);
        }
      }

      // Close on backdrop click
      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closeLightbox();
      });

      // Close button
      closeBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        closeLightbox();
      });

      // Prevent content clicks from closing
      content.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    }

    // ESC key to close
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && activeLightbox) {
        closeLightbox();
      }
    });

    // Zoom button click
    document.addEventListener('click', function (e) {
      var btn = e.target.closest('.markmap-zoom-btn');
      if (!btn) return;
      var wrapper = btn.closest('.markmap-wrapper');
      if (!wrapper) return;
      openLightbox(wrapper);
    });
  })();
</script>

<!-- Mermaid -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Match PaperMod's theme: checks localStorage first, then system preference
  const stored = localStorage.getItem('pref-theme');
  const isDark = stored === 'dark' ||
    (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches);

  mermaid.initialize({
    startOnLoad: true,
    theme: isDark ? 'dark' : 'neutral',
    flowchart: { useMaxWidth: true, htmlLabels: true },
    securityLevel: 'loose',
  });
</script>

<!-- Tag Cloud Styles -->
<style>
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 16px 0 24px;
  }

  .tag-cloud-item {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 16px;
    font-size: 0.85em;
    background: var(--tertiary);
    color: var(--secondary);
    text-decoration: none;
    transition: background 0.2s ease, transform 0.15s ease;
  }

  .tag-cloud-item:hover {
    background: var(--primary);
    color: var(--theme);
    transform: translateY(-1px);
  }

  .entry-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
    position: relative;
    z-index: 1;
  }

  .entry-tag {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    background: var(--tertiary);
    color: var(--secondary);
    text-decoration: none;
    transition: background 0.2s ease, transform 0.15s ease;
  }

  .entry-tag:hover {
    background: var(--primary);
    color: var(--theme);
    transform: translateY(-1px);
  }

  /* Highlighter pen effect */
  mark {
    background: linear-gradient(120deg, #fff176 0%, #aed581 100%);
    color: #1a1a1a;
    padding: 2px 6px;
    border-radius: 4px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }

  .dark mark {
    background: linear-gradient(120deg, #f9a825 0%, #7cb342 100%);
    color: #1a1a1a;
  }
</style>